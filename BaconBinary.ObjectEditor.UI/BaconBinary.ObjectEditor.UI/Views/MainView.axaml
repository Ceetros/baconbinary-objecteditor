<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:BaconBinary.ObjectEditor.UI.ViewModels"
             xmlns:cv="using:BaconBinary.ObjectEditor.UI.Converters"
             xmlns:models="using:BaconBinary.Core.Models"
             xmlns:views="using:BaconBinary.ObjectEditor.UI.Views"
             x:Class="BaconBinary.ObjectEditor.UI.Views.MainView"
             x:Name="RootView"
             x:DataType="vm:MainViewModel">
    
    <UserControl.Resources>
        <cv:ThingToBitmapConverter x:Key="ThingToBitmapConverter"/>
    </UserControl.Resources>

    <Grid>
        <!-- Editor View (shown when IsEditing is True) -->
        <views:EditorView DataContext="{Binding}" IsVisible="{Binding IsEditing}"/>

        <!-- Main Browser View (shown when IsEditing is False) -->
        <Grid RowDefinitions="Auto, *" IsVisible="{Binding !IsEditing}">
            
            <!-- Top Toolbar -->
            <Border Grid.Row="0" Background="{DynamicResource HeaderBackgroundBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1" Padding="0">
                <Grid ColumnDefinitions="Auto, *, Auto">
                    
                    <!-- Main Menu -->
                    <Menu Grid.Column="0" Background="Transparent">
                        <MenuItem Header="BaconEditor" FontWeight="Bold" FontSize="14" Foreground="{DynamicResource TextPrimaryBrush}">
                            <MenuItem.Icon>
                                <Image Source="{DynamicResource BaconIcon}" Width="20" Height="20" />
                            </MenuItem.Icon>
                            
                            <MenuItem Header="Open Project" Command="{Binding OpenFilesCommand}" CommandParameter="{Binding #RootView}" InputGesture="Ctrl+O">
                                <MenuItem.Icon>
                                    <PathIcon Data="{StaticResource FolderOpenRegular}" />
                                </MenuItem.Icon>
                            </MenuItem>
                            
                            <Separator/>
                            
                            <MenuItem Header="Compile" Command="{Binding CompileProjectCommand}" InputGesture="Ctrl+S">
                                <MenuItem.Icon>
                                    <PathIcon Data="{StaticResource SaveRegular}" />
                                </MenuItem.Icon>
                            </MenuItem>
                            
                            <MenuItem Header="Compile As..." Command="{Binding CompileProjectAsCommand}" CommandParameter="{Binding #RootView}" InputGesture="Ctrl+Shift+S">
                                <MenuItem.Icon>
                                    <PathIcon Data="{StaticResource SaveAsRegular}" />
                                </MenuItem.Icon>
                            </MenuItem>
                            
                            <Separator/>
                            
                            <MenuItem Header="Exit" InputGesture="Alt+F4"/>
                        </MenuItem>
                        
                        <MenuItem Header="View">
                            <MenuItem Header="Reset Layout"/>
                        </MenuItem>
                        
                        <MenuItem Header="Help">
                            <MenuItem Header="About" Command="{Binding OpenAboutCommand}"/>
                            <MenuItem Header="Donate" Command="{Binding DonateCommand}"/>
                        </MenuItem>
                    </Menu>

                    <!-- Version Badge -->
                    <Border Grid.Column="2" Background="{DynamicResource AccentBrush}" CornerRadius="4" Padding="8,2" Margin="0,0,12,0" VerticalAlignment="Center">
                        <TextBlock Text="{Binding VersionString}" Foreground="#0D1117" FontWeight="Bold" FontSize="11" VerticalAlignment="Center"/>
                    </Border>
                </Grid>
            </Border>

            <!-- Main Content Area -->
            <Grid Grid.Row="1" ColumnDefinitions="300, 4, *, 4, 280">

                <!-- LEFT COLUMN: Inspector (Preview & Properties) -->
                <Grid Grid.Column="0" RowDefinitions="Auto, *" Margin="0,0,0,0" Background="{DynamicResource PanelBackgroundBrush}">
                    
                    <!-- Preview Panel -->
                    <Border Grid.Row="0" Margin="8" Padding="0" Background="{DynamicResource AppBackgroundBrush}" CornerRadius="8" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                        <Grid RowDefinitions="Auto, Auto">
                            <Border Grid.Row="0" Height="160" CornerRadius="8,8,0,0" ClipToBounds="True" Background="{DynamicResource CheckerboardBrush}">
                                <Image Source="{Binding SelectedItem, Converter={StaticResource ThingToBitmapConverter}}" 
                                       Stretch="None" 
                                       HorizontalAlignment="Center" 
                                       VerticalAlignment="Center"/>
                            </Border>
                            
                            <Border Grid.Row="1" Background="{DynamicResource HeaderBackgroundBrush}" CornerRadius="0,0,8,8" Padding="10,6">
                                <Grid ColumnDefinitions="*, Auto">
                                    <TextBlock Text="{Binding SelectedItem.Id, StringFormat='ID: {0}'}" FontWeight="Bold" Foreground="{DynamicResource TextPrimaryBrush}"/>
                                    <TextBlock Grid.Column="1" Text="Item" Foreground="{DynamicResource AccentBrush}" FontSize="11" VerticalAlignment="Center"/>
                                </Grid>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- Properties Panel -->
                    <Border Grid.Row="1" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
                        <ScrollViewer Padding="12">
                            <StackPanel Spacing="16">
                                
                                <!-- General Flags -->
                                <StackPanel Spacing="8">
                                    <TextBlock Text="General Properties" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}" FontSize="12"/>
                                    <Grid ColumnDefinitions="*, *" RowDefinitions="Auto, Auto, Auto, Auto" >
                                        <CheckBox Content="Ground" IsChecked="{Binding SelectedItem.IsGround, FallbackValue=False}"/>
                                        <CheckBox Content="Container" IsChecked="{Binding SelectedItem.IsContainer, FallbackValue=False}"/>
                                        <CheckBox Content="Stackable" IsChecked="{Binding SelectedItem.IsStackable, FallbackValue=False}"/>
                                        <CheckBox Content="Force Use" IsChecked="{Binding SelectedItem.ForceUse, FallbackValue=False}"/>
                                        <CheckBox Content="Writable" IsChecked="{Binding SelectedItem.IsWritable, FallbackValue=False}"/>
                                        <CheckBox Content="Fluid" IsChecked="{Binding SelectedItem.IsFluid, FallbackValue=False}"/>
                                        <CheckBox Content="Multi-Use" IsChecked="{Binding SelectedItem.IsMultiUse, FallbackValue=False}"/>
                                        <CheckBox Content="Rotatable" IsChecked="{Binding SelectedItem.IsRotatable, FallbackValue=False}"/>
                                    </Grid>
                                </StackPanel>

                                <Separator Background="{DynamicResource BorderBrush}" Height="1"/>

                                <!-- Collision Flags -->
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Collision &amp; Movement" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}" FontSize="12"/>
                                    <CheckBox Content="Block Solid" IsChecked="{Binding SelectedItem.IsUnpassable, FallbackValue=False}"/>
                                    <CheckBox Content="Block Projectile" IsChecked="{Binding SelectedItem.BlockMissile, FallbackValue=False}"/>
                                    <CheckBox Content="Block Pathfind" IsChecked="{Binding SelectedItem.BlockPathfind, FallbackValue=False}"/>
                                </StackPanel>

                                <Separator Background="{DynamicResource BorderBrush}" Height="1"/>

                                <!-- Visual Flags -->
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Visual Attributes" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}" FontSize="12"/>
                                    <CheckBox Content="Always Animate" IsChecked="{Binding SelectedItem.AnimateAlways, FallbackValue=False}"/>
                                    <CheckBox Content="Lying Object" IsChecked="{Binding SelectedItem.IsLyingObject, FallbackValue=False}"/>
                                    <CheckBox Content="Top Effect" IsChecked="{Binding SelectedItem.IsTopEffect, FallbackValue=False}"/>
                                    <CheckBox Content="Translucent" IsChecked="{Binding SelectedItem.IsTranslucent, FallbackValue=False}"/>
                                </StackPanel>
                                
                            </StackPanel>
                        </ScrollViewer>
                    </Border>
                </Grid>

                <GridSplitter Grid.Column="1" Background="{DynamicResource BorderBrush}" ResizeBehavior="PreviousAndNext"/>

                <!-- CENTER COLUMN: Browser -->
                <Grid Grid.Column="2" RowDefinitions="Auto, *">
                    
                    <!-- Search & Filter Bar -->
                    <Border Grid.Row="0" Background="{DynamicResource PanelBackgroundBrush}" Padding="8" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
                        <Grid ColumnDefinitions="Auto, *, Auto">
                            <ComboBox Grid.Column="0" SelectedIndex="{Binding SelectedCategoryIndex}" Margin="0,0,8,0" Width="120">
                                <ComboBoxItem>Items</ComboBoxItem>
                                <ComboBoxItem>Outfits</ComboBoxItem>
                                <ComboBoxItem>Effects</ComboBoxItem>
                                <ComboBoxItem>Missiles</ComboBoxItem>
                            </ComboBox>
                            
                            <TextBox Grid.Column="1" Watermark="Search by ID or Name..." CornerRadius="4" Classes="SearchBox"/>
                            
                            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="4" Margin="8,0,0,0">
                                <Button Content="Filter" Classes="AccentButton"/>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Items Grid -->
                    <ListBox Grid.Row="1" 
                             ItemsSource="{Binding Items}" 
                             SelectedItem="{Binding SelectedItem}"
                             DoubleTapped="EditItem_OnDoubleTapped"
                             Background="{DynamicResource AppBackgroundBrush}"
                             BorderThickness="0"
                             Padding="8"
                             ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                        
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel ItemWidth="40" ItemHeight="40" />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>

                        <ListBox.ItemTemplate>
                            <DataTemplate x:DataType="models:ThingType">
                                <Border Background="{DynamicResource PanelBackgroundBrush}" 
                                        BorderBrush="{DynamicResource BorderBrush}" 
                                        BorderThickness="1" 
                                        CornerRadius="4"
                                        ToolTip.Tip="{Binding Id, StringFormat='ID: {0}'}">
                                    <Border.ContextMenu>
                                        <ContextMenu>
                                            <MenuItem Header="Edit Item" Command="{Binding $parent[ListBox].DataContext.EditItemCommand}"/>
                                            <MenuItem Header="Copy ID"/>
                                        </ContextMenu>
                                    </Border.ContextMenu>
                                    <Image Source="{Binding ., Converter={StaticResource ThingToBitmapConverter}}" 
                                           Stretch="None" 
                                           HorizontalAlignment="Center" 
                                           VerticalAlignment="Center"/>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                    
                    <!-- Loading Overlay -->
                    <Grid Grid.Row="1" Background="#AA0D1117" IsVisible="{Binding IsLoading, FallbackValue=False}">
                        <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="10">
                            <ProgressBar IsIndeterminate="True" Width="100" Foreground="{DynamicResource AccentBrush}"/>
                            <TextBlock Text="Loading Assets..." Foreground="{DynamicResource TextPrimaryBrush}"/>
                        </StackPanel>
                    </Grid>
                </Grid>

                <GridSplitter Grid.Column="3" Background="{DynamicResource BorderBrush}" ResizeBehavior="PreviousAndNext"/>

                <!-- RIGHT COLUMN: Sprites & Details -->
                <Grid Grid.Column="4" RowDefinitions="*, Auto" Background="{DynamicResource PanelBackgroundBrush}">
                    
                    <Grid Grid.Row="0" RowDefinitions="Auto, *">
                        <Border Grid.Row="0" Background="{DynamicResource HeaderBackgroundBrush}" Padding="8">
                            <TextBlock Text="SPRITES" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11"/>
                        </Border>
                        
                        <ScrollViewer Grid.Row="1" Padding="8">
                            <ItemsControl ItemsSource="{Binding SelectedItem.FrameGroups}">
                                 <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel />
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Width="36" Height="36" Margin="2" Background="{DynamicResource CheckerboardBrush}" CornerRadius="2" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1">
                                            <!-- Placeholder for sprite image -->
                                            <TextBlock Text="{Binding}" FontSize="8" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>

                    <!-- Statistics Footer -->
                    <Border Grid.Row="1" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0" Padding="12">
                        <StackPanel Spacing="8">
                            <TextBlock Text="STATISTICS" FontWeight="Bold" Foreground="{DynamicResource TextSecondaryBrush}" FontSize="11" Margin="0,0,0,4"/>
                            
                            <Grid ColumnDefinitions="*, Auto">
                                <TextBlock Text="Total Items" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding ItemCount}" FontWeight="Bold"/>
                            </Grid>
                            <Grid ColumnDefinitions="*, Auto">
                                <TextBlock Text="Total Outfits" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding OutfitCount}" FontWeight="Bold"/>
                            </Grid>
                            <Grid ColumnDefinitions="*, Auto">
                                <TextBlock Text="Total Sprites" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="{Binding SpriteCount}" FontWeight="Bold"/>
                            </Grid>
                        </StackPanel>
                    </Border>
                </Grid>

            </Grid>
            
            <!-- Status Bar -->
            <Border Grid.Row="1" VerticalAlignment="Bottom" HorizontalAlignment="Stretch" 
                    Background="{DynamicResource AccentBrush}" Height="4"
                    IsVisible="{Binding IsLoading}"/>
        </Grid>
    </Grid>
</UserControl>
