<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:cv="using:BaconBinary.ObjectEditor.UI.Converters"
             xmlns:vm="using:BaconBinary.ObjectEditor.UI.ViewModels"
             xmlns:models="using:BaconBinary.Core.Models"
             xmlns:sys="using:System"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
             x:Class="BaconBinary.ObjectEditor.UI.Views.EditorView"
             x:DataType="vm:MainViewModel"
             Background="{DynamicResource AppBackgroundBrush}"
             Foreground="{DynamicResource TextPrimaryBrush}">

    <UserControl.Styles>
        <Style Selector="ListBox">
            <Setter Property="Background" Value="Transparent"/>
        </Style>
    </UserControl.Styles>

    <UserControl.Resources>
        <cv:SpriteIdToBitmapConverter x:Key="SpriteIdToBitmapConverter"/>
        <cv:ThingToBitmapConverter x:Key="ThingToBitmapConverter"/>
        <cv:CategoryToVisibilityConverter x:Key="CategoryToVisibilityConverter"/>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto, *">
        
        <!-- Header / Toolbar -->
        <Border Grid.Row="0" Background="{DynamicResource HeaderBackgroundBrush}" Padding="10" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
            <Grid ColumnDefinitions="Auto, *, Auto">
                <StackPanel Orientation="Horizontal" Spacing="10">
                    <Button Classes="AccentButton" Content="← Back" Width="80" Command="{Binding ExitEditModeCommand}"/>
                    <TextBlock Text="{Binding SelectedItem.Id, StringFormat='Editing: ID {0}'}" VerticalAlignment="Center" FontWeight="Bold" FontSize="16"/>
                </StackPanel>
                
                <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                    <Button Content="Import Sprite"/>
                    <Button Content="Export"/>
                    <Button Classes="AccentButton" Content="Save Changes" Command="{Binding SaveChangesCommand}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Main Workspace -->
        <Grid Grid.Row="1" ColumnDefinitions="320, 4, *, 4, 340">

            <!-- LEFT COLUMN: Resources (Objects & Sprites) -->
            <Grid Grid.Column="0" RowDefinitions="*, 4, *">
                
                <!-- Object List (Quick Switch) -->
                <Border Grid.Row="0" Classes="Panel">
                    <Grid RowDefinitions="Auto, *, Auto">
                        <TextBlock Text="{Binding SelectedCategoryIndex, Converter={x:Static cv:CategoryIndexToStringConverter.Instance}}" Classes="PanelTitle" Margin="10"/>
                        <ScrollViewer Grid.Row="1">
                            <ListBox ItemsSource="{Binding EditorItems}" SelectedItem="{Binding SelectedItem}">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel ItemWidth="48" ItemHeight="60"/>
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                <ListBox.ItemTemplate>
                                    <DataTemplate x:DataType="models:ThingType">
                                        <Border Classes="SelectableItem" Background="{DynamicResource PanelBackgroundBrush}" Margin="2">
                                            <StackPanel Spacing="4">
                                                <Image Source="{Binding ., Converter={StaticResource ThingToBitmapConverter}}" Width="32" Height="32" Stretch="None"/>
                                                <TextBlock Text="{Binding Id}" FontSize="9" HorizontalAlignment="Center" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </ScrollViewer>
                        <Border Grid.Row="2" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0" Padding="8">
                            <Grid ColumnDefinitions="Auto, *, Auto">
                                <Button Grid.Column="0" Content="&lt; Prev" Command="{Binding ChangeItemPageCommand}" CommandParameter="prev"/>
                                <TextBlock Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryBrush}">
                                    <Run Text="{Binding CurrentItemPage}"/>/<Run Text="{Binding TotalItemPages}"/>
                                </TextBlock>
                                <Button Grid.Column="2" Content="Next &gt;" Command="{Binding ChangeItemPageCommand}" CommandParameter="next"/>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>

                <GridSplitter Grid.Row="1" Background="{DynamicResource BorderBrush}" ResizeBehavior="PreviousAndNext"/>

                <!-- Sprite Palette (Source) -->
                <Border Grid.Row="2" Classes="Panel">
                    <Grid RowDefinitions="Auto, Auto, *, Auto">
                        <TextBlock Text="SPRITE PALETTE" Classes="PanelTitle" Margin="10"/>
                        <TextBox Grid.Row="1" Watermark="Search Sprite ID..." Margin="5"/>
                        <ScrollViewer Grid.Row="2">
                            <ItemsControl ItemsSource="{Binding SpriteIds}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel ItemWidth="36" ItemHeight="36"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate x:DataType="sys:UInt32">
                                        <Border Background="{DynamicResource CheckerboardBrush}" Margin="2" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="2"
                                                PointerPressed="OnSpriteDrag">
                                            <Image Source="{Binding ., Converter={StaticResource SpriteIdToBitmapConverter}}" Stretch="None" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                        <Border Grid.Row="3" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0" Padding="8">
                            <Grid ColumnDefinitions="Auto, *, Auto">
                                <Button Grid.Column="0" Content="&lt; Prev" Command="{Binding ChangeSpritePageCommand}" CommandParameter="prev"/>
                                <TextBlock Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{DynamicResource TextSecondaryBrush}">
                                    <Run Text="{Binding CurrentSpritePage}"/>/<Run Text="{Binding TotalSpritePages}"/>
                                </TextBlock>
                                <Button Grid.Column="2" Content="Next &gt;" Command="{Binding ChangeSpritePageCommand}" CommandParameter="next"/>
                            </Grid>
                        </Border>
                    </Grid>
                </Border>
            </Grid>

            <GridSplitter Grid.Column="1" Background="{DynamicResource BorderBrush}" ResizeBehavior="PreviousAndNext"/>

            <!-- CENTER COLUMN: The Stage (Composer) -->
            <Grid Grid.Column="2" RowDefinitions="Auto, *, Auto" Background="{DynamicResource PanelBackgroundBrush}">
                
                <!-- Visual Properties (Dimensions) -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="15" HorizontalAlignment="Center" Margin="10">
                    <ComboBox ItemsSource="{Binding SelectedItem.FrameGroups.Keys}" SelectedItem="{Binding SelectedFrameGroup}" Width="120"
                              IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=1}"/>
                    <Rectangle Width="1" Height="30" Fill="{DynamicResource BorderBrush}"
                               IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=1}"/>
                    <StackPanel>
                        <TextBlock Text="Width" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <NumericUpDown Value="{Binding TempProps.Width}" Minimum="1" Maximum="32" LostFocus="OnResizeLostFocus"/>
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Height" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <NumericUpDown Value="{Binding TempProps.Height}" Minimum="1" Maximum="32" LostFocus="OnResizeLostFocus"/>
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Pattern X" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <NumericUpDown Value="{Binding TempProps.PatternX}" Minimum="1" Maximum="32" LostFocus="OnResizeLostFocus"/>
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Pattern Y" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <NumericUpDown Value="{Binding TempProps.PatternY}" Minimum="1" Maximum="32" LostFocus="OnResizeLostFocus"/>
                    </StackPanel>
                    <StackPanel>
                        <TextBlock Text="Pattern Z" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                        <NumericUpDown Value="{Binding TempProps.PatternZ}" Minimum="1" Maximum="32" LostFocus="OnResizeLostFocus"/>
                    </StackPanel>
                </StackPanel>

                <!-- The Canvas & Direction Controls -->
                <Grid Grid.Row="1" HorizontalAlignment="Center" VerticalAlignment="Center">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="50"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="50"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="50"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="50"/>
                    </Grid.RowDefinitions>

                    <Button Grid.Row="0" Grid.Column="1" Content="▲" HorizontalAlignment="Center" Classes="AccentButton" ToolTip.Tip="North" Command="{Binding SetDirectionCommand}" CommandParameter="North"
                            IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=!0}"/>
                    <Button Grid.Row="1" Grid.Column="0" Content="◀" VerticalAlignment="Center" Classes="AccentButton" ToolTip.Tip="West" Command="{Binding SetDirectionCommand}" CommandParameter="West"
                            IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=!0}"/>
                    <Button Grid.Row="1" Grid.Column="2" Content="▶" VerticalAlignment="Center" Classes="AccentButton" ToolTip.Tip="East" Command="{Binding SetDirectionCommand}" CommandParameter="East"
                            IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=!0}"/>
                    <Button Grid.Row="2" Grid.Column="1" Content="▼" HorizontalAlignment="Center" Classes="AccentButton" ToolTip.Tip="South" Command="{Binding SetDirectionCommand}" CommandParameter="South"
                            IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=!0}"/>

                    <!-- Main Preview / Drop Area -->
                    <Border Grid.Row="1" Grid.Column="1" BorderBrush="{DynamicResource AccentBrush}" BorderThickness="1" CornerRadius="4" Margin="10">
                        <ItemsControl ItemsSource="{Binding ComposerSlots}" Width="{Binding ComposerWidth}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel ItemWidth="32" ItemHeight="32"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="vm:SpriteSlotViewModel">
                                    <Border Background="{DynamicResource CheckerboardBrush}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1"
                                            DragDrop.AllowDrop="True" DragDrop.DragEnter="OnSlotDragEnter" DragDrop.DragLeave="OnSlotDragLeave" DragDrop.Drop="OnSlotDrop">
                                        <Image Source="{Binding SpriteId, Converter={StaticResource SpriteIdToBitmapConverter}}" Stretch="None"/>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </Border>
                </Grid>

                <!-- Animation Timeline -->
                <Border Grid.Row="2" Background="{DynamicResource HeaderBackgroundBrush}" Padding="10" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
                    <Grid ColumnDefinitions="Auto, *, Auto">
                        <Button Grid.Column="0" Classes="AccentButton" Width="80" Command="{Binding ToggleAnimationCommand}">
                            <Panel>
                                <StackPanel Orientation="Horizontal" Spacing="5" IsVisible="{Binding !IsPlaying}"><TextBlock Text="▶"/><TextBlock Text="Play"/></StackPanel>
                                <StackPanel Orientation="Horizontal" Spacing="5" IsVisible="{Binding IsPlaying}"><TextBlock Text="❚❚"/><TextBlock Text="Pause"/></StackPanel>
                            </Panel>
                        </Button>
                        <Slider Grid.Column="1" Minimum="0" Maximum="{Binding SelectedItem.Frames}" Value="{Binding CurrentFrameIndex}" Margin="20,0"/>
                        <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="10">
                            <TextBlock Text="Addon/Mount (Z):" VerticalAlignment="Center"/>
                            <NumericUpDown Value="{Binding CurrentPatternZ}" Maximum="{Binding SelectedItem.PatternZ}"/>
                        </StackPanel>
                    </Grid>
                </Border>
            </Grid>

            <GridSplitter Grid.Column="3" Background="{DynamicResource BorderBrush}" ResizeBehavior="PreviousAndNext"/>

            <!-- RIGHT COLUMN: Properties (Flags) -->
            <Border Grid.Column="4" Classes="Panel">
                <Grid RowDefinitions="Auto, *">
                    <TextBlock Text="PROPERTIES" Classes="PanelTitle" Margin="10"/>
                    <ScrollViewer Grid.Row="1" Padding="10">
                        <StackPanel Spacing="15">
                            
                            <!-- Global Properties -->
                            <StackPanel Spacing="5">
                                <TextBlock Text="Global" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                <CheckBox Content="Always Animate" IsChecked="{Binding TempProps.AnimateAlways}"/>
                            </StackPanel>
                            
                            <Separator Background="{DynamicResource BorderBrush}" Height="1"/>
                            
                            <!-- Item-Specific Properties -->
                            <StackPanel Spacing="5" IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=0}">
                                <TextBlock Text="General" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                <UniformGrid Columns="2">
                                    <CheckBox Content="Ground" IsChecked="{Binding TempProps.IsGround}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Container" IsChecked="{Binding TempProps.IsContainer}"/>
                                    <CheckBox Content="Stackable" IsChecked="{Binding TempProps.IsStackable}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Force Use" IsChecked="{Binding TempProps.ForceUse}"/>
                                    <CheckBox Content="Multi-Use" IsChecked="{Binding TempProps.IsMultiUse}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Writable" IsChecked="{Binding TempProps.IsWritable}"/>
                                    <CheckBox Content="Readable" IsChecked="{Binding TempProps.IsReadable}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Fluid Container" IsChecked="{Binding TempProps.IsFluid}"/>
                                    <CheckBox Content="Fluid" IsChecked="{Binding TempProps.IsFluid}" Margin="0,0,5,0"/>
                                </UniformGrid>
                            </StackPanel>
                            
                            <Separator IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=0}" Background="{DynamicResource BorderBrush}" Height="1"/>
                            
                            <StackPanel Spacing="5" IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=0}">
                                <TextBlock Text="Movement &amp; Collision" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                <UniformGrid Columns="2">
                                    <CheckBox Content="Block Solid" IsChecked="{Binding TempProps.IsUnpassable}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Block Projectile" IsChecked="{Binding TempProps.BlockMissile}"/>
                                    <CheckBox Content="Block Pathfind" IsChecked="{Binding TempProps.BlockPathfind}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Walk Stack" IsChecked="{Binding TempProps.WalkStack}"/>
                                </UniformGrid>
                            </StackPanel>

                            <Separator IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=0}" Background="{DynamicResource BorderBrush}" Height="1"/>

                            <StackPanel Spacing="5" IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=0}">
                                <TextBlock Text="Visual" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                <UniformGrid Columns="2">
                                    <CheckBox Content="Lying Object" IsChecked="{Binding TempProps.IsLyingObject}"/>
                                    <CheckBox Content="Top Effect" IsChecked="{Binding TempProps.IsTopEffect}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Translucent" IsChecked="{Binding TempProps.IsTranslucent}"/>
                                    <CheckBox Content="Rotatable" IsChecked="{Binding TempProps.IsRotatable}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Hangable" IsChecked="{Binding TempProps.IsHangable}"/>
                                    <CheckBox Content="Hook South" IsChecked="{Binding TempProps.IsHookSouth}" Margin="0,0,5,0"/>
                                    <CheckBox Content="Hook East" IsChecked="{Binding TempProps.IsHookEast}"/>
                                </UniformGrid>
                            </StackPanel>
                            
                            <Separator Background="{DynamicResource BorderBrush}" Height="1"/>

                            <StackPanel Spacing="8">
                                <TextBlock Text="Displacement" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                <CheckBox Content="Has Offset" IsChecked="{Binding TempProps.HasOffset}"/>
                                <Grid ColumnDefinitions="*, 10, *">
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Offset X" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <NumericUpDown Value="{Binding TempProps.OffsetX}" IsEnabled="{Binding TempProps.HasOffset}"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Offset Y" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <NumericUpDown Value="{Binding TempProps.OffsetY}" IsEnabled="{Binding TempProps.HasOffset}"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>

                            <Separator IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=0}" Background="{DynamicResource BorderBrush}" Height="1"/>

                            <StackPanel Spacing="8" IsVisible="{Binding SelectedCategoryIndex, Converter={StaticResource CategoryToVisibilityConverter}, ConverterParameter=0}">
                                <TextBlock Text="Market" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                <CheckBox Content="Is Market Item" IsChecked="{Binding TempProps.IsMarketItem}"/>
                                <TextBox Text="{Binding TempProps.MarketName}" Watermark="Market Name" IsEnabled="{Binding TempProps.IsMarketItem}"/>
                                <UniformGrid Columns="2">
                                    <StackPanel Margin="0,0,5,0">
                                        <TextBlock Text="Category" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <NumericUpDown Value="{Binding TempProps.MarketCategory}" IsEnabled="{Binding TempProps.IsMarketItem}"/>
                                    </StackPanel>
                                    <StackPanel>
                                        <TextBlock Text="Trade As" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <NumericUpDown Value="{Binding TempProps.MarketTradeAs}" IsEnabled="{Binding TempProps.IsMarketItem}"/>
                                    </StackPanel>
                                    <StackPanel Margin="0,0,5,0">
                                        <TextBlock Text="Show As" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <NumericUpDown Value="{Binding TempProps.MarketShowAs}" IsEnabled="{Binding TempProps.IsMarketItem}"/>
                                    </StackPanel>
                                    <StackPanel>
                                        <TextBlock Text="Restrict Level" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                        <NumericUpDown Value="{Binding TempProps.MarketRestrictLevel}" IsEnabled="{Binding TempProps.IsMarketItem}"/>
                                    </StackPanel>
                                </UniformGrid>
                                <StackPanel>
                                    <TextBlock Text="Restrict Profession" FontSize="10" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                    <NumericUpDown Value="{Binding TempProps.MarketRestrictProfession}" IsEnabled="{Binding TempProps.IsMarketItem}"/>
                                </StackPanel>
                            </StackPanel>
                            
                            <Separator Background="{DynamicResource BorderBrush}" Height="1"/>

                            <StackPanel Spacing="5">
                                <TextBlock Text="Light" FontWeight="Bold" Foreground="{DynamicResource AccentBrush}"/>
                                <TextBlock Text="• Light Level (TODO)" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                                <TextBlock Text="• Light Color (TODO)" FontSize="11" Foreground="{DynamicResource TextSecondaryBrush}"/>
                            </StackPanel>

                        </StackPanel>
                    </ScrollViewer>
                </Grid>
            </Border>

        </Grid>
    </Grid>
</UserControl>
